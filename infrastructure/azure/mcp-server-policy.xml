<!--
    MCP Server Policy Configuration for Azure API Management
    
    This policy configuration provides:
    - MCP protocol compliance (2025-06-18)
    - CORS support for AI agents
    - JSON-RPC 2.0 error handling
    - Rate limiting integration
    - Lex Research API branding
    
    Apply this policy to your MCP server in Azure API Management portal.
-->
<policies>
    <!-- Throttle, authorize, validate, cache, or transform the requests -->
    <inbound>
        <!-- Inherit global rate limiting from base API policies -->
        <base />
        
        <!-- MCP-specific CORS for AI agents -->
        <cors allow-credentials="false">
            <allowed-origins>
                <origin>*</origin>
            </allowed-origins>
            <allowed-methods>
                <method>GET</method>
                <method>POST</method>
                <method>OPTIONS</method>
            </allowed-methods>
            <allowed-headers>
                <header>Content-Type</header>
                <header>Accept</header>
                <header>Authorization</header>
                <header>X-Requested-With</header>
                <header>Cache-Control</header>
            </allowed-headers>
        </cors>
        
        <!-- Set MCP-specific headers -->
        <set-header name="X-MCP-Server" exists-action="override">
            <value>Lex Research API</value>
        </set-header>
        
        <!-- Validate Content-Type for MCP requests -->
        <choose>
            <when condition="@(context.Request.Method == "POST")">
                <check-header name="Content-Type" failed-check-httpcode="400" failed-check-error-message="Content-Type header is required for MCP requests" ignore-case="true">
                    <value>application/json</value>
                </check-header>
            </when>
        </choose>
        
        <!-- Ensure proper Accept headers for MCP protocol -->
        <set-header name="Accept" exists-action="skip">
            <value>application/json, text/event-stream</value>
        </set-header>
    </inbound>
    
    <!-- Control if and how the requests are forwarded to services  -->
    <backend>
        <base />
    </backend>
    
    <!-- Customize the responses -->
    <outbound>
        <!-- Inherit base policies including rate limit headers -->
        <base />
        
        <!-- Add MCP protocol version header -->
        <set-header name="X-MCP-Protocol-Version" exists-action="override">
            <value>2025-06-18</value>
        </set-header>
        
        <!-- Add server identification -->
        <set-header name="X-MCP-Server-Name" exists-action="override">
            <value>Lex Research API</value>
        </set-header>
        
        <!-- Add usage guidance -->
        <set-header name="X-MCP-Documentation" exists-action="override">
            <value>https://github.com/i-dot-ai/lex</value>
        </set-header>
    </outbound>
    
    <!-- Handle exceptions and customize error responses  -->
    <on-error>
        <!-- Custom MCP error responses -->
        <choose>
            <when condition="@(context.Response.StatusCode == 429)">
                <return-response>
                    <set-status code="429" reason="Too Many Requests" />
                    <set-header name="Retry-After" exists-action="override">
                        <value>60</value>
                    </set-header>
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return new JObject(
                            new JProperty("jsonrpc", "2.0"),
                            new JProperty("id", "rate-limit-error"),
                            new JProperty("error", new JObject(
                                new JProperty("code", -32603),
                                new JProperty("message", "Rate limit exceeded for MCP server"),
                                new JProperty("data", new JObject(
                                    new JProperty("retry_after", 60),
                                    new JProperty("limit", "20 requests per minute"),
                                    new JProperty("documentation", "https://github.com/i-dot-ai/lex")
                                ))
                            ))
                        ).ToString();
                    }</set-body>
                </return-response>
            </when>
            <when condition="@(context.Response.StatusCode >= 400)">
                <set-header name="Content-Type" exists-action="override">
                    <value>application/json</value>
                </set-header>
                <set-body>@{
                    return new JObject(
                        new JProperty("jsonrpc", "2.0"),
                        new JProperty("id", "server-error"),
                        new JProperty("error", new JObject(
                            new JProperty("code", -32603),
                            new JProperty("message", "MCP server error"),
                            new JProperty("data", new JObject(
                                new JProperty("http_status", context.Response.StatusCode),
                                new JProperty("server", "Lex Research API"),
                                new JProperty("documentation", "https://github.com/i-dot-ai/lex")
                            ))
                        ))
                    ).ToString();
                }</set-body>
            </when>
        </choose>
        <base />
    </on-error>
</policies>